package com.example.diplom.ui.screens

import android.widget.Toast
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.alpha
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavController
import com.example.diplom.data.TokenManager
import com.example.diplom.data.model.DepartmentItem
import com.example.diplom.data.model.FacultyItem
import com.example.diplom.data.model.Location
import com.example.diplom.data.model.User
import com.example.diplom.data.network.RetrofitClient
import com.example.diplom.data.repository.AuthRepository
import com.example.diplom.ui.theme.*
import com.example.diplom.viewmodel.AuthViewModel
import com.example.diplom.viewmodel.AuthViewModelFactory
import com.example.myapplication.R
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun AddUserScreen(
    navController: NavController,
    role: String,
    tokenManager: TokenManager
) {
    val context = LocalContext.current
    val apiService = RetrofitClient.apiService
    val authViewModel: AuthViewModel = viewModel(
        factory = AuthViewModelFactory(AuthRepository(apiService, tokenManager), tokenManager)
    )

    var name by remember { mutableStateOf("") }
    var login by remember { mutableStateOf("") }
    var password by remember { mutableStateOf("") }
    var rank by remember { mutableStateOf("") }
    var groupIdText by remember { mutableStateOf("") }

    var nameError by remember { mutableStateOf(false) }
    var loginError by remember { mutableStateOf(false) }
    var passwordError by remember { mutableStateOf(false) }
    var rankError by remember { mutableStateOf(false) }
    var groupIdError by remember { mutableStateOf(false) }

    var isAdding by remember { mutableStateOf(false) }
    val coroutineScope = rememberCoroutineScope()

    var parentUsers by remember { mutableStateOf<List<User>>(emptyList()) }
    var selectedParentId by remember { mutableStateOf<Int?>(null) }
    var expanded by remember { mutableStateOf(false) }

    var courseIdText by remember { mutableStateOf("") }
    var courseIdError by remember { mutableStateOf(false) }

    var faculties by remember { mutableStateOf<List<FacultyItem>>(emptyList()) }
    var selectedFacultyId by remember { mutableStateOf<Int?>(null) }
    var facultyExpanded by remember { mutableStateOf(false) }

    var departments by remember { mutableStateOf<List<DepartmentItem>>(emptyList()) }
    var selectedDepartmentId by remember { mutableStateOf<Int?>(null) }
    var departmentExpanded by remember { mutableStateOf(false) }

    var locations by remember { mutableStateOf<List<Location>>(emptyList()) }
    var selectedLocationId by remember { mutableStateOf<Int?>(null) }
    var locationExpanded by remember { mutableStateOf(false) }




    val normalizedRole = when (role) {
        "kg" -> "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏"
        "nk" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É"
        "nf" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É"
        "nkf" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫–∞—Ñ–µ–¥—Ä–∏"
        "cl" -> "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó" // üü¢ –î–û–î–ê–ô –û–¶–ï
        else -> role
    }

    LaunchedEffect(normalizedRole) {
        val managerRole = when (normalizedRole) {
            "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É"
            "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É"
            "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó", "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫–∞—Ñ–µ–¥—Ä–∏" -> "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É"
            else -> null
        }

        if (managerRole != null) {
            parentUsers = authViewModel.getUsersByRole(managerRole) ?: emptyList()
        }

        if (normalizedRole == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É") {
            faculties = authViewModel.getFaculties() ?: emptyList()
        }

        if (normalizedRole == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫–∞—Ñ–µ–¥—Ä–∏") {
            departments = authViewModel.getDepartments() ?: emptyList()
        }

        // üÜï –î–æ–¥–∞–π –æ—Å—å —Ü–µ:
        if (normalizedRole == "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó") {
            locations = authViewModel.getLocations() ?: emptyList()
        }
        if (normalizedRole == "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó") {
            selectedParentId = null
        }

    }




    Box(modifier = Modifier.fillMaxSize().background(CyberBackground)) {
        Image(
            painter = painterResource(id = R.drawable.institute_logo),
            contentDescription = null,
            contentScale = ContentScale.Crop,
            modifier = Modifier.fillMaxSize().alpha(0.08f)
        )

        Card(
            modifier = Modifier
                .padding(24.dp)
                .fillMaxWidth()
                .align(Alignment.Center),
            shape = RoundedCornerShape(16.dp),
            colors = CardDefaults.cardColors(containerColor = CyberCard),
            elevation = CardDefaults.cardElevation(10.dp)
        ) {


            Column(modifier = Modifier.padding(24.dp), horizontalAlignment = Alignment.CenterHorizontally) {
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(bottom = 8.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    IconButton(onClick = { navController.popBackStack() }) {
                        Icon(
                            imageVector = Icons.Default.ArrowBack,
                            contentDescription = "–ù–∞–∑–∞–¥",
                            tint = SoftAccent
                        )
                    }
                    Spacer(modifier = Modifier.width(8.dp))
                    Text(
                        text = "–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞",
                        color = SoftAccent,
                        fontFamily = FontFamily.SansSerif,
                        fontSize = 20.sp
                    )
                }

                CustomInputField("–Ü–º'—è", name, { name = it; nameError = false }, nameError)
                if (nameError) ErrorText("–Ü–º‚Äô—è –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 2 –¥–æ 30 —Å–∏–º–≤–æ–ª—ñ–≤")

                Spacer(modifier = Modifier.height(10.dp))

                CustomInputField("–õ–æ–≥—ñ–Ω", login, { login = it; loginError = false }, loginError)
                if (loginError) ErrorText("–õ–æ–≥—ñ–Ω –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 3 –¥–æ 20 —Å–∏–º–≤–æ–ª—ñ–≤")

                Spacer(modifier = Modifier.height(10.dp))

                CustomInputField(
                    "–ü–∞—Ä–æ–ª—å",
                    password,
                    { password = it; passwordError = false },
                    passwordError,
                    isPassword = true
                )
                if (passwordError) ErrorText("–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 6 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤")

                Spacer(modifier = Modifier.height(10.dp))

                CustomInputField(
                    "–í—ñ–π—Å—å–∫–æ–≤–µ –∑–≤–∞–Ω–Ω—è",
                    rank,
                    { rank = it; rankError = false },
                    rankError
                )
                if (rankError) ErrorText("–ó–≤–∞–Ω–Ω—è –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 2 –¥–æ 50 —Å–∏–º–≤–æ–ª—ñ–≤")

                if (normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É") {
                    Spacer(modifier = Modifier.height(10.dp))
                    CustomInputField(
                        "–ö—É—Ä—Å",
                        courseIdText,
                        { courseIdText = it; courseIdError = false },
                        courseIdError
                    )
                    if (courseIdError) ErrorText("–ö—É—Ä—Å –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –∫—É—Ä—Å—É")
                }


                if (normalizedRole  == "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏") {
                    Spacer(modifier = Modifier.height(10.dp))
                    CustomInputField(
                        "–ù–æ–º–µ—Ä –≥—Ä—É–ø–∏",
                        groupIdText,
                        { groupIdText = it; groupIdError = false },
                        groupIdError
                    )
                    if (groupIdError) ErrorText("–ì—Ä—É–ø–∞ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥–∏—Ä–∞ –≥—Ä—É–ø–∏")
                }

                if (parentUsers.isNotEmpty() && normalizedRole != "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó") {
                    Spacer(modifier = Modifier.height(10.dp))
                    ExposedDropdownMenuBox(
                        expanded = expanded,
                        onExpandedChange = { expanded = !expanded }
                    ) {
                        OutlinedTextField(
                            value = parentUsers.find { it.id == selectedParentId }?.name
                                ?: "–û–±–µ—Ä—ñ—Ç—å –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞",
                            onValueChange = {},
                            readOnly = true,
                            label = { Text("–ö–µ—Ä—ñ–≤–Ω–∏–∫", color = CyberText) },
                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = expanded) },
                            modifier = Modifier.menuAnchor().fillMaxWidth(),
                            colors = TextFieldDefaults.colors(
                                focusedContainerColor = CyberCard,
                                unfocusedContainerColor = CyberCard,
                                focusedTextColor = CyberText,
                                unfocusedTextColor = CyberText,
                                focusedIndicatorColor = SoftAccent,
                                unfocusedIndicatorColor = CyberText
                            )
                        )
                        ExposedDropdownMenu(
                            expanded = expanded,
                            onDismissRequest = { expanded = false }
                        ) {
                            parentUsers.forEach { user ->
                                DropdownMenuItem(
                                    text = { Text(user.name, fontFamily = FontFamily.SansSerif) },
                                    onClick = {
                                        selectedParentId = user.id
                                        expanded = false
                                    }
                                )
                            }
                        }
                    }
                }

                if ((normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É" || normalizedRole  == "nf") && faculties.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(10.dp))
                    ExposedDropdownMenuBox(
                        expanded = facultyExpanded,
                        onExpandedChange = { facultyExpanded = !facultyExpanded }
                    ) {
                        OutlinedTextField(
                            value = faculties.find { it.id == selectedFacultyId }?.name
                                ?: "–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–∫—É–ª—å—Ç–µ—Ç",
                            onValueChange = {},
                            readOnly = true,
                            label = { Text("–§–∞–∫—É–ª—å—Ç–µ—Ç", color = CyberText) },
                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = facultyExpanded) },
                            modifier = Modifier.menuAnchor().fillMaxWidth(),
                            colors = TextFieldDefaults.colors(
                                focusedContainerColor = CyberCard,
                                unfocusedContainerColor = CyberCard,
                                focusedTextColor = CyberText,
                                unfocusedTextColor = CyberText,
                                focusedIndicatorColor = SoftAccent,
                                unfocusedIndicatorColor = CyberText
                            )
                        )
                        ExposedDropdownMenu(
                            expanded = facultyExpanded,
                            onDismissRequest = { facultyExpanded = false }
                        ) {
                            faculties.forEach { faculty ->
                                DropdownMenuItem(
                                    text = {
                                        Text(
                                            faculty.name,
                                            fontFamily = FontFamily.SansSerif
                                        )
                                    },
                                    onClick = {
                                        selectedFacultyId = faculty.id
                                        facultyExpanded = false
                                    }
                                )
                            }
                        }
                    }
                }
                if (normalizedRole == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫–∞—Ñ–µ–¥—Ä–∏" && departments.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(10.dp))
                    ExposedDropdownMenuBox(
                        expanded = departmentExpanded,
                        onExpandedChange = { departmentExpanded = !departmentExpanded }
                    ) {
                        OutlinedTextField(
                            value = departments.find { it.id == selectedDepartmentId }?.name ?: "–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ñ–µ–¥—Ä—É",
                            onValueChange = {},
                            readOnly = true,
                            label = { Text("–ö–∞—Ñ–µ–¥—Ä–∞", color = CyberText) },
                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = departmentExpanded) },
                            modifier = Modifier.menuAnchor().fillMaxWidth(),
                            colors = TextFieldDefaults.colors(
                                focusedContainerColor = CyberCard,
                                unfocusedContainerColor = CyberCard,
                                focusedTextColor = CyberText,
                                unfocusedTextColor = CyberText,
                                focusedIndicatorColor = SoftAccent,
                                unfocusedIndicatorColor = CyberText
                            )
                        )
                        ExposedDropdownMenu(
                            expanded = departmentExpanded,
                            onDismissRequest = { departmentExpanded = false }
                        ) {
                            departments.forEach { department ->
                                DropdownMenuItem(
                                    text = { Text(department.name, fontFamily = FontFamily.SansSerif) },
                                    onClick = {
                                        selectedDepartmentId = department.id
                                        departmentExpanded = false
                                    }
                                )
                            }
                        }
                    }
                }

                if (normalizedRole == "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó" && locations.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(10.dp))
                    ExposedDropdownMenuBox(
                        expanded = locationExpanded,
                        onExpandedChange = { locationExpanded = !locationExpanded }
                    ) {
                        OutlinedTextField(
                            value = locations.find { it.id == selectedLocationId }?.name ?: "–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é",
                            onValueChange = {},
                            readOnly = true,
                            label = { Text("–õ–æ–∫–∞—Ü—ñ—è", color = CyberText) },
                            trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded = locationExpanded) },
                            modifier = Modifier.menuAnchor().fillMaxWidth(),
                            colors = TextFieldDefaults.colors(
                                focusedContainerColor = CyberCard,
                                unfocusedContainerColor = CyberCard,
                                focusedTextColor = CyberText,
                                unfocusedTextColor = CyberText,
                                focusedIndicatorColor = SoftAccent,
                                unfocusedIndicatorColor = CyberText
                            )
                        )
                        ExposedDropdownMenu(
                            expanded = locationExpanded,
                            onDismissRequest = { locationExpanded = false }
                        ) {
                            locations.forEach { location ->
                                DropdownMenuItem(
                                    text = { Text(location.name, fontFamily = FontFamily.SansSerif) },
                                    onClick = {
                                        selectedLocationId = location.id
                                        locationExpanded = false
                                    }
                                )
                            }
                        }
                    }
                }




                Spacer(modifier = Modifier.height(20.dp))

                Button(
                    onClick = {
                        nameError = name.length !in 2..30
                        loginError = login.length !in 3..20
                        passwordError = password.length !in 6..50
                        rankError = rank.length !in 2..50
                        groupIdError = normalizedRole  == "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏" && groupIdText.isBlank()
                        courseIdError = normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É" && courseIdText.isBlank()

                        val hasError = nameError || loginError || passwordError || rankError || groupIdError || courseIdError
                        val parentError = (normalizedRole  == "—á–µ—Ä–≥–æ–≤–∏–π_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É" ||  normalizedRole  == "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏") && selectedParentId == null
                        val facultyError = normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É" && selectedFacultyId == null

                        if (parentError || facultyError) {
                            Toast.makeText(context, "–ù–µ –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è", Toast.LENGTH_SHORT).show()
                            return@Button
                        }

                        if (!hasError) {
                            isAdding = true

                            if (normalizedRole  == "–∫–æ–º–∞–Ω–¥–∏—Ä_–≥—Ä—É–ø–∏" && selectedParentId != null) {
                                authViewModel.getUserById(selectedParentId!!) { nkUser ->
                                    val courseIdString = nkUser?.course_id?.toString()

                                    if (courseIdString == null) {
                                        isAdding = false
                                        Toast.makeText(context, "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫—É—Ä—Å –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞", Toast.LENGTH_LONG).show()
                                        return@getUserById
                                    }

                                    authViewModel.addUser(
                                        name = name,
                                        login = login,
                                        password = password,
                                        role = role,
                                        rank = rank,
                                        groupNumber = groupIdText,
                                        parentId = selectedParentId,
                                        courseId = courseIdString,
                                        facultyId = selectedDepartmentId
                                    ) { success, errorMessage, _ ->
                                        isAdding = false
                                        if (success) {
                                            Toast.makeText(context, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!", Toast.LENGTH_SHORT).show()
                                            navController.previousBackStackEntry?.savedStateHandle?.set("user_added", true)
                                            navController.popBackStack()
                                        } else {
                                            Toast.makeText(context, "–ü–æ–º–∏–ª–∫–∞: $errorMessage", Toast.LENGTH_LONG).show()
                                        }
                                    }
                                }

                            } else if ((normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É" || normalizedRole  == "nf") && selectedFacultyId != null) {
                                authViewModel.addUser(
                                    name = name,
                                    login = login,
                                    password = password,
                                    role = role,
                                    rank = rank,
                                    groupNumber = null,
                                    parentId = null,
                                    courseId = null,
                                    facultyId = selectedFacultyId
                                ) { success, errorMessage, _ ->
                                    isAdding = false
                                    if (success) {
                                        Toast.makeText(context, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!", Toast.LENGTH_SHORT).show()
                                        navController.previousBackStackEntry?.savedStateHandle?.set("user_added", true)
                                        navController.popBackStack()
                                    } else {
                                        Toast.makeText(context, "–ü–æ–º–∏–ª–∫–∞: $errorMessage", Toast.LENGTH_LONG).show()
                                    }
                                }

                            }
                            else if (normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫–∞—Ñ–µ–¥—Ä–∏" && selectedParentId != null) {
                                authViewModel.addUser(
                                    name = name,
                                    login = login,
                                    password = password,
                                    role = role,
                                    rank = rank,
                                    groupNumber = null,
                                    parentId = selectedParentId,
                                    courseId = null,
                                    facultyId = null // –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ
                                ) { success, errorMessage, _ ->
                                    isAdding = false
                                    if (success) {
                                        Toast.makeText(context, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!", Toast.LENGTH_SHORT).show()
                                        navController.previousBackStackEntry?.savedStateHandle?.set("user_added", true)
                                        navController.popBackStack()
                                    } else {
                                        Toast.makeText(context, "–ü–æ–º–∏–ª–∫–∞: $errorMessage", Toast.LENGTH_LONG).show()
                                    }
                                }
                            }

                            else if (normalizedRole  == "–Ω–∞—á–∞–ª—å–Ω–∏–∫_–∫—É—Ä—Å—É" && selectedParentId != null) {
                                authViewModel.addUser(
                                    name = name,
                                    login = login,
                                    password = password,
                                    role = role,
                                    rank = rank,
                                    groupNumber = null,
                                    parentId = selectedParentId,
                                    courseId = courseIdText,
                                    facultyId = null
                                ) { success, errorMessage, _ ->
                                    isAdding = false
                                    if (success) {
                                        Toast.makeText(context, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!", Toast.LENGTH_SHORT).show()
                                        navController.previousBackStackEntry?.savedStateHandle?.set("user_added", true)
                                        navController.popBackStack()
                                    } else {
                                        Toast.makeText(context, "–ü–æ–º–∏–ª–∫–∞: $errorMessage", Toast.LENGTH_LONG).show()
                                    }
                                }
                            }

                            else if (normalizedRole == "—á–µ—Ä–≥–æ–≤–∏–π_–ª–æ–∫–∞—Ü—ñ—ó" && selectedLocationId != null) {
                                authViewModel.addUser(
                                    name = name,
                                    login = login,
                                    password = password,
                                    role = role,
                                    rank = rank,
                                    groupNumber = null,
                                    parentId = null,              // üîπ –Ω–µ –º–∞—î –∫–µ—Ä—ñ–≤–Ω–∏–∫–∞
                                    courseId = null,
                                    facultyId = null,
                                    departmentId = null,
                                    locationId = selectedLocationId // ‚úÖ –ø–µ—Ä–µ–¥–∞—î–º–æ —Å–∞–º–µ —è–∫ locationId
                                ) { success, errorMessage, _ ->
                                    isAdding = false
                                    if (success) {
                                        Toast.makeText(context, "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–¥–∞–Ω–æ!", Toast.LENGTH_SHORT).show()
                                        navController.previousBackStackEntry?.savedStateHandle?.set("user_added", true)
                                        navController.popBackStack()
                                    } else {
                                        Toast.makeText(context, "–ü–æ–º–∏–ª–∫–∞: $errorMessage", Toast.LENGTH_LONG).show()
                                    }
                                }
                            }



                        } else {
                            Toast.makeText(context, "–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–ª—è!", Toast.LENGTH_SHORT).show()
                        }
                    },
                    modifier = Modifier.fillMaxWidth(),
                    enabled = !isAdding,
                    colors = ButtonDefaults.buttonColors(containerColor = SoftAccent),
                    shape = RoundedCornerShape(12.dp)
                ) {
                    if (isAdding) {
                        CircularProgressIndicator(color = CyberCard, modifier = Modifier.size(24.dp))
                    } else {
                        Text("–î–æ–¥–∞—Ç–∏", color = CyberBackground, fontFamily = FontFamily.SansSerif)
                    }
                }
            }
        }
    }
}

@Composable
fun CustomInputField(
    label: String,
    value: String,
    onValueChange: (String) -> Unit,
    isError: Boolean,
    isPassword: Boolean = false
) {
    OutlinedTextField(
        value = value,
        onValueChange = onValueChange,
        label = {
            Text(label, color = CyberText, fontFamily = FontFamily.SansSerif)
        },
        modifier = Modifier
            .fillMaxWidth()
            .padding(vertical = 4.dp),
        isError = isError,
        visualTransformation = if (isPassword) PasswordVisualTransformation() else VisualTransformation.None,
        textStyle = LocalTextStyle.current.copy(fontFamily = FontFamily.SansSerif),
        colors = TextFieldDefaults.colors(
            focusedTextColor = CyberText,
            unfocusedTextColor = CyberText,
            focusedContainerColor = CyberCard,
            unfocusedContainerColor = CyberCard,
            focusedIndicatorColor = SoftAccent,
            unfocusedIndicatorColor = CyberText,
            cursorColor = SoftAccent,
            errorContainerColor = CyberCard,
            errorIndicatorColor = Color.Red,
            errorLabelColor = SoftAccent
        )
    )
}

@Composable
fun ErrorText(text: String) {
    Text(
        text = text,
        color = Color(0xFFFF6B6B),
        fontSize = 13.sp,
        fontFamily = FontFamily.SansSerif,
        modifier = Modifier
            .fillMaxWidth()
            .padding(start = 6.dp)
    )
}
